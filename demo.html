<!DOCTYPE html>
<html ng-app="demo">
<head>
    <title>On Mark</title>
    <style>
        html,body{
            height: 100%;}
        body{
            font-family:Consolas, "Liberation Mono", Courier, monospace;
            background: radial-gradient(ellipse at center, #d2ff52 0%,#91e842 100%); /* W3C */
        }
        header,article{text-align: center;}
        *{margin: 0}
        .domains{
            display: none;
        }
        section {
            width: 61.8%;
            margin:0 auto;

        }
        #display{
            padding: 0.62em;
            border-radius: 2px;
            box-sizing: border-box;
            width: 61.8%;;
            margin:0 auto;
            background: linear-gradient(to bottom, #ffd65e 0%,#febf04 100%); /* W3C */
            margin-top: 5px;
            max-height: 80%;
            overflow-y:auto;
            box-shadow: 0 0 3px;
            text-align: center;
        }
        #display > article {
            line-height: 2em;
        }
        #display > article > img{
            margin-right: 3px;
            box-shadow: 0 0 3px;
        }

        #controller > article > * {
            margin-bottom: 3px;
        }

        #config {
            border: solid #EFD675 2px;
            border-radius: 2px;
        }
        #config > * {
            margin: 2px 0;
        }

        #imgNum{
            color: #cd1914;
            font-weight: bold;
        }
        li {
            list-style: none;
        }
        li.img{
            display: inline-block;
            margin-right: 2px;
        }
        ul{
            padding: 0;
        }
        #results {
            border-left: #33458E solid;
            text-align: initial;
        }
        .result {
            border-left: solid #F0F8FF;
            margin-bottom: 5px;
            background-color: #FFDF00;
        }
        .result li:first-child {
            border: solid #3355AB 2px;
            border-radius: 2px;
            background: #F5AB48;
            margin-bottom: 5px;
        }
    </style>
</head>
<body ng-controller="ctrl">

<section id="controller">
    <header><h2>window</h2></header>
    <article>
        <label for="origin">Start: </label>
        <input type="text" id="origin" placeholder="on your mark" ng-model="origin"/>
        <input type="button" id="go" value="{{statusText}}" ng-click="start()"/>
        <div id="config">
            <div><input type="checkbox" id="originAsArray" ng-model="originAsArray"><label for="originAsArray"> treat origin as an array split with ',' </label></div>
            <div class="filter">
                <input type="text" id="imgFilter" ng-model="imgFilter"><label for="imgFilter"> img filter</label>
            </div>
            <div class="filter">
                <input type="text" id="aFilter" ng-model="aFilter" placeholder="thread-928\d{4}-1"><label for="aFilter"> linkfilter</label>
            </div>
        </div>
    </article>
</section>
<section id="domains" class="domains">
    <header></header>
    <article>
    </article>
</section>

<section id="display" class="box">
    Add tentacle.user.js to your TamperMonkey(chrome) or Greasemonkey(firefox), or just drag this file into the window of chrome://extensions/.<br>
    Open the console. After "pause, turn:1" has shown, call steptwo()
    <hr/>
    <header>Result Images: <button ng-click="collapseAll()">collapse all</button></header>
    <article>
        <ul id="results">
            <li class="turn" ng-repeat="result in results">
                <div ng-repeat="(key, resource) in result.data" class="result">
                    <ul ng-if="key == 'src' || key == 'href'">
                        <li class="url"><a target="_blank" href="{{result.url}}">{{key}}, {{result.url|limitTo:20}}..</a></li>
                        <li ng-if="resource.$rediectUrl" class="url"><a target="_blank" href="{{resource.$rediectUrl}}">{{resource.$rediectUrl}}</a></li>

                        <li ng-if="key == 'href'"><button ng-init="resource.showA=false" ng-click="resource.showA=!resource.showA">show link</button></li>
                        <li ng-if="resource.showA" class="url-result" ng-repeat="a in resource | linkFilter: aFilter">{{a | limitTo : 50}}</li>

                        <li ng-if="key == 'src'"><button ng-init="resource.showImg=false" ng-click="resource.showImg=!resource.showImg">show img</button></li>
                        <li ng-if="resource.showImg" class="img" ng-repeat="pic in resource | filter: imgFilter">
                            <img ng-src="{{pic}}">
                        </li>
                    </ul>
                    <div class="fetch-me" ng-if="key == 'href'">
                        <input type="button" ng-disabled="busy" ng-click="fetchMe(resource)" value="fetch me">
                    </div>
                </div>
            </li>
        </ul>
    </article>
</section>
<script src="bolero.js"></script>
<script src="bower_components/angularjs/angular.js"></script>
<script>
    angular.module('demo', []).controller('ctrl', function($scope, bolero, $filter) {
        $scope.origin = "http://www.douban.com/search?q=Evangelion";
        $scope.getImg = true;
        $scope.getA = true;
        $scope.busy = true;
        $scope.originAsArray = true;
        $scope.statusText = 'start';

        $scope.start = function() {
            if (!$scope.origin) return
            crawler.queue($scope.origin)
            crawler.run()
        };
        $scope.fetchMe = function(links) {
            $scope.busy = true;
            crawler.queue($scope.aFilter ? filter(links, $scope.aFilter) : links).run()
        };
        $scope.collapseAll = function() {
        };

        var Crawler = bolero.Crawler
        var absUrl = bolero.util.absUrl
        var linkExt = bolero.extractor.linkExtractor
        var imgExt = bolero.extractor.attrExtractor('img', 'src')
        var crawler = new Crawler({
            callback: function(html, response) {
                var link = linkExt(html);
                link.href = absUrl(response.url, unique(link.href))
                var img = imgExt(html);
                img.src = absUrl(response.url, unique(img.src))
                link.src = img.src
                return link
            },
            drain: function() {
                $scope.busy = false
                console.log('Crawling Done!');
                $scope.$apply()
            },
            progress: function(result) {
                console.log('progress: ' + result.url);
                $scope.$apply()
            }
        })
        $scope.results = crawler.results;

        var filter = $filter('linkFilter');

        function unique(array) {
            var obj = {}
            array.forEach(function(item) {
                if (obj[item]) return
                obj[item] = true
            })
            return Object.keys(obj)
        }

    }).factory('bolero', function($window) {
        return $window.bolero
    }).filter('linkFilter', function() {
      return function(array, re) {
        if (!array || !re) return array
        var ret =[], re = new RegExp(re)
        array.forEach(function(link) {
            if (re.test(link)) {
                ret.push(link)
            }
        })
          return ret
      }
    })
</script>
</body>
</html>
